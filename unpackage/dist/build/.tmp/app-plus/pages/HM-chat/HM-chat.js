(global["webpackJsonp"]=global["webpackJsonp"]||[]).push([["pages/HM-chat/HM-chat"],{"5a33":function(e,t,i){"use strict";(function(e){i("65f7"),i("921b");s(i("66fd"));var t=s(i("bc8b"));function s(e){return e&&e.__esModule?e:{default:e}}e(t.default)}).call(this,i("6e42")["createPage"])},"7ed9":function(e,t,i){"use strict";var s=i("ec4e"),n=i.n(s);n.a},"9ecb":function(e,t,i){"use strict";(function(e,s){Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var n=r(i("dfb6")),o=i("2f62");function r(e){return e&&e.__esModule?e:{default:e}}function c(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{},s=Object.keys(i);"function"===typeof Object.getOwnPropertySymbols&&(s=s.concat(Object.getOwnPropertySymbols(i).filter(function(e){return Object.getOwnPropertyDescriptor(i,e).enumerable}))),s.forEach(function(t){a(e,t,i[t])})}return e}function a(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}var h=function(){return i.e("components/emotion/index").then(i.bind(null,"76d4"))},u=i("6007"),l=i("704e"),d={components:{emotion:h},computed:(0,o.mapState)(["linkList","userName","user","serverUrl"]),data:function(){return{textMsg:"",isHistoryLoading:!1,scrollAnimation:!1,scrollTop:0,scrollToView:"",msgList:[],msgImgList:[],myuid:0,to:"",RECORDER:e.getRecorderManager(),isVoice:!1,voiceTis:"按住 说话",recordTis:"手指上滑 取消发送",recording:!1,willStop:!1,initPoint:{identifier:0,Y:0},recordTimer:null,recordLength:0,id:"",AUDIO:e.createInnerAudioContext(),playMsgid:null,VoiceTimer:null,popupLayerClass:"",hideMore:!0,hideEmoji:!0,emojiList:[{}],emojiPath:"",windowsState:"",redenvelopeData:{rid:null,from:null,face:null,blessing:null,money:null}}},onLoad:function(t){var i=this,s=t.id,o=this;this.id=s,this.to=this.linkList[this.id].title,this.getMsgList(),this.AUDIO.onEnded(function(e){i.playMsgid=null}),this.RECORDER.onStart(function(e){i.recordBegin(e)}),this.RECORDER.onStop(function(e){i.recordEnd(e)}),l.on("em.chat.reSuccess",function(e){var t=o.linkList;o.$nextTick(function(){o.scrollToView="msg"+(t[o.id].history.length-1)})}),this.emojiList=n.default.imgArr[1].emojiList,e.setNavigationBarTitle({title:this.linkList[s].name,success:function(){}})},onBackPress:function(e){console.log(s(e," at pages\\HM-chat\\HM-chat.vue:308"));var t=this.linkList;t[this.id].count=null,this.setLinkList(t)},onShow:function(){this.scrollTop=9999999},methods:c({},(0,o.mapMutations)(["setLinkList"]),{screenMsg:function(e){var t=this.linkList;if("system"==e.type)switch(e.msg.type){case"text":this.addSystemTextMsg(e);break;case"redEnvelope":this.addSystemRedEnvelopeMsg(e);break}else if("user"==e.type)switch(e.msg.type){case"text":t[this.id].message=e.msg.content.text.length>8?"信息[文字]":e.msg.content.text,this.addTextMsg(e);break;case"voice":t[this.id].message="信息[语音]",this.addVoiceMsg(e);break;case"img":t[this.id].message="信息[图片]",this.addImgMsg(e);break;case"redEnvelope":this.addRedEnvelopeMsg(e);break}t[this.id].history=this.msgList,this.setLinkList(t),this.$nextTick(function(){this.scrollToView="msg"+(t[this.id].history.length-1)}),l.fire("em.chat.saveHistory")},loadHistory:function(e){console.log(s("加载历史记录。。"," at pages\\HM-chat\\HM-chat.vue:380")),this.isHistoryLoading=!1},getMsgList:function(){for(var e=this.linkList[this.id].history,t=0;t<e.length;t++)"user"==e[t].type&&"img"==e[t].msg.type&&(e[t].msg.content=this.setPicSize(e[t].msg.content),this.msgImgList.push(e[t].msg.content.url));this.msgList=e,this.$nextTick(function(){this.scrollTop=9999,this.$nextTick(function(){this.scrollAnimation=!0})})},setPicSize:function(t){var i=e.upx2px(350),s=e.upx2px(350);if(t.w>i||t.h>s){var n=t.w/t.h;t.w=n>1?i:s*n,t.h=n>1?i/n:s}return t},showMore:function(){this.isVoice=!1,this.hideEmoji=!0,this.hideMore?(this.hideMore=!1,this.openDrawer()):this.hideDrawer()},openDrawer:function(){this.popupLayerClass="showLayer"},hideDrawer:function(){var e=this;this.popupLayerClass="",setTimeout(function(){e.hideMore=!0,e.hideEmoji=!0},150)},chooseImage:function(){this.getImage("album")},camera:function(){this.getImage("camera")},handRedEnvelopes:function(){e.showToast({icon:"none",title:"该功能暂未实现"})},getImage:function(t){var i=this;this.hideDrawer();var s=this;e.chooseImage({sourceType:[t],sizeType:["original","compressed"],success:function(t){for(var n=function(n){e.getImageInfo({src:t.tempFilePaths[n],success:function(o){var r={jpg:!0,gif:!0,png:!0,bmp:!0},c=i.$im.conn.context.accessToken,a=s.$im.config.appkey.split("#"),h=o.width,l=o.height,d=o.path.lastIndexOf("."),g=~d&&o.path.slice(d+1)||"";g.toLowerCase()in r&&e.uploadFile({url:"https://a1.easemob.com/"+a[0]+"/"+a[1]+"/chatfiles",filePath:t.tempFilePaths[n],name:"file",header:{"Content-Type":"multipart/form-data",Authorization:"Bearer "+c},success:function(e){var i=e.data,o=JSON.parse(i),r=s.$im.conn.getUniqueId(),c=new s.$im.message(u.IMAGE,r),a={type:u.IMAGE,size:{width:h,height:l},url:o.uri+"/"+o.entities[0].uuid,filetype:g,filename:t.tempFilePaths[n]};c.set({apiUrl:s.$im.config.apiURL,body:a,from:s.user.phone,to:s.to,roomType:!1,chatType:"singleChat",ext:s.user,success:function(e){var i=new Date,o={type:"user",msg:{id:s.linkList[s.id].history.length,time:i.getHours()+":"+i.getMinutes(),type:"img",userinfo:{uid:s.user.id,username:s.user.username,face:s.user.headimage},content:{url:t.tempFilePaths[n],w:h,h:l}}};s.screenMsg(o)}}),s.$im.conn.send(c.body)}})}})},o=0;o<t.tempFilePaths.length;o++)n(o)}})},chooseEmoji:function(){this.hideMore=!0,this.hideEmoji?(this.hideEmoji=!1,this.openDrawer()):this.hideDrawer()},addEmoji:function(e){if("[删除]"===e.emojiItem.alt){var t,i=this.textMsg.length-1,s=this.textMsg.lastIndexOf("["),o=this.textMsg.lastIndexOf("]"),r=o-s;return t=-1!=o&&o===i&&r>=2&&r<=4?this.textMsg.slice(0,s):this.textMsg.slice(0,i),void(this.textMsg=t)}this.emojiList=n.default.imgArr[e.groupIndex].emojiList,this.emojiPath=n.default.imgArr[e.groupIndex].emojiPath,!1===e.minEmoji?this.sendBigEmoji(e.emojiItem.url):this.textMsg+=e.emojiItem.alt},sendBigEmoji:function(e){if(this.hideDrawer(),e){var t='<img style="width:48px;height:48px;" src="'+this.emojiPath+e+'">',i='<div style="display:flex;align-items: center;word-wrap:break-word;">'+t+"</div>",s={text:i};this.sendMsg(s,"text"),this.textMsg=""}},textareaFocus:function(){"showLayer"==this.popupLayerClass&&0==this.hideMore&&this.hideDrawer()},sendText:function(){if(this.hideDrawer(),this.textMsg){var e=this.replaceEmoji(this.textMsg),t={text:e};this.sendMsg(t,"text"),this.textMsg=""}},replaceEmoji:function(e){var t=this,i=e.replace(/\[([^(\]|\[)]*)\]/g,function(e,i){for(var s=0;s<t.emojiList.length;s++)for(var n=t.emojiList[s],o=0;o<n.length;o++){var r=n[o];if(r.alt==e){var c=t.emojiPath,a='<img style="width:24px;height:24px;" src="'+c+r.url+'">';return a}}});return'<div style="align-items: center;word-wrap:break-word;">'+i+"</div>"},sendMsg:function(e,t){if("text"==t){var i=this,n=this.$im.conn.getUniqueId(),o=new this.$im.message(u.TEXT,n);o.set({msg:e.text,from:this.user.phone,to:this.to,roomType:!1,ext:i.user,chatType:"singleChat",success:function(s,n){var o=new Date;this.id;var r={type:"user",msg:{id:i.linkList[i.id].history.length,time:o.getHours()+":"+o.getMinutes(),type:t,userinfo:{uid:i.user.id,username:i.user.username,face:i.user.headimage},content:e}};i.screenMsg(r)},fail:function(e,t){console.log(s("发送信息失败了"," at pages\\HM-chat\\HM-chat.vue:695"))}});try{this.$im.conn.send(o.body)}catch(r){console.log(s(r," at pages\\HM-chat\\HM-chat.vue:704"))}}},addTextMsg:function(e){this.msgList.push(e)},addVoiceMsg:function(e){this.msgList.push(e)},addImgMsg:function(e){e.msg.content=this.setPicSize(e.msg.content),this.msgImgList.push(e.msg.content.url),this.msgList.push(e)},addRedEnvelopeMsg:function(e){this.msgList.push(e)},addSystemTextMsg:function(e){this.msgList.push(e)},addSystemRedEnvelopeMsg:function(e){},openRedEnvelope:function(e,t){},closeRedEnvelope:function(){},sendSystemMsg:function(e,t){},toDetails:function(e){},showPic:function(t){e.previewImage({indicator:"none",current:t.content.url,urls:[t.content.url]})},playVoice:function(e){this.playMsgid=e.id,this.AUDIO.src=e.content.url,this.$nextTick(function(){this.AUDIO.play()})},voiceBegin:function(e){e.touches.length>1||(this.initPoint.Y=e.touches[0].clientY,this.initPoint.identifier=e.touches[0].identifier,this.RECORDER.start({format:"mp3"}))},recordBegin:function(e){var t=this;this.recording=!0,this.voiceTis="松开 结束",this.recordLength=0,this.recordTimer=setInterval(function(){t.recordLength++},1e3)},voiceCancel:function(){this.recording=!1,this.voiceTis="按住 说话",this.recordTis="手指上滑 取消发送",this.willStop=!0,this.RECORDER.stop()},voiceIng:function(t){if(this.recording){var i=t.touches[0];this.initPoint.Y-i.clientY>=e.upx2px(100)?(this.willStop=!0,this.recordTis="松开手指 取消发送"):(this.willStop=!1,this.recordTis="手指上滑 取消发送")}},voiceEnd:function(e){this.recording&&(this.recording=!1,this.voiceTis="按住 说话",this.recordTis="手指上滑 取消发送",this.RECORDER.stop())},recordEnd:function(t){if(clearInterval(this.recordTimer),!this.willStop){var i={length:0,url:t.tempFilePath},s=parseInt(this.recordLength/60),n=this.recordLength%60;s=s<10?"0"+s:s,n=n<10?"0"+n:n,i.length=s+":"+n;var o=this.$im.config.appkey.split("#"),r=this,c=this.$im.conn.context.accessToken;e.uploadFile({url:"https://a1.easemob.com/"+o[0]+"/"+o[1]+"/chatfiles",filePath:i.url,name:"file",header:{"Content-Type":"multipart/form-data",Authorization:"Bearer "+c},success:function(e){var t=r.$im.conn.getUniqueId(),s=new r.$im.message(u.AUDIO,t),n=JSON.parse(e.data);s.set({apiUrl:r.$im.config.apiURL,accessToken:c,body:{type:u.AUDIO,url:n.uri+"/"+n.entities[0].uuid,filetype:"",filename:i.url,accessToken:c,length:Math.ceil(i.length)},from:r.user.phone,to:r.to,roomType:!1,chatType:"singleChat",ext:r.user,success:function(e){l.fire("em.chat.sendSuccess",t);var s=new Date,n={type:"user",msg:{id:r.linkList[r.id].history.length,time:s.getHours()+":"+s.getMinutes(),type:"voice",userinfo:{uid:r.user.id,username:r.user.username,face:r.user.headimage},content:i}};r.screenMsg(n)}}),r.$im.conn.send(s.body)}})}this.willStop=!1},switchVoice:function(){this.hideDrawer(),this.isVoice=!this.isVoice},discard:function(){}})};t.default=d}).call(this,i("6e42")["default"],i("0de9")["default"])},b749:function(e,t,i){"use strict";i.r(t);var s=i("9ecb"),n=i.n(s);for(var o in s)"default"!==o&&function(e){i.d(t,e,function(){return s[e]})}(o);t["default"]=n.a},bc8b:function(e,t,i){"use strict";i.r(t);var s=i("ccc7"),n=i("b749");for(var o in n)"default"!==o&&function(e){i.d(t,e,function(){return n[e]})}(o);i("7ed9");var r,c=i("f0c5"),a=Object(c["a"])(n["default"],s["b"],s["c"],!1,null,null,null,!1,s["a"],r);t["default"]=a.exports},ccc7:function(e,t,i){"use strict";var s,n=function(){var e=this,t=e.$createElement;e._self._c},o=[];i.d(t,"b",function(){return n}),i.d(t,"c",function(){return o}),i.d(t,"a",function(){return s})},ec4e:function(e,t,i){}},[["5a33","common/runtime","common/vendor"]]]);